// apps/server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- 1. USERS ---
model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  password  String
  fullName  String?   @map("full_name")
  phone     String?
  role      Role      @default(USER)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  bookings  Booking[]
  reviews   Review[]
  payments  Payment[]

  @@map("users")
}

enum Role {
  USER
  ADMIN
  GUIDE
}

// --- 2. TOURS (Catalog) ---
model Tour {
  id            Int      @id @default(autoincrement())
  name          String
  slug          String   @unique // SEO URL
  summary       String?
  description   String?  @db.Text
  coverImage    String?  @map("cover_image")
  images        Json?    // Lưu mảng ảnh
  durationDays  Int      @map("duration_days")
  priceAdult    Decimal  @map("price_adult") @db.Decimal(10, 2)
  priceChild    Decimal  @map("price_child") @db.Decimal(10, 2)
  location      String?
  ratingAverage Decimal  @default(0) @map("rating_average") @db.Decimal(2, 1)
  
  // NEW FIELDS
  status        TourStatus @default(DRAFT)
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  deletedAt     DateTime?  @map("deleted_at")

  schedules     TourSchedule[]
  reviews       Review[]

  @@index([status])
  @@index([deletedAt])
  @@map("tours")
}

enum TourStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// --- 3. SCHEDULES (Inventory) ---
model TourSchedule {
  id              Int            @id @default(autoincrement())
  tourId          Int            @map("tour_id")
  startDate       DateTime       @map("start_date")
  maxCapacity     Int            @map("max_capacity")
  currentCapacity Int            @default(0) @map("current_capacity")
  status          ScheduleStatus @default(OPEN)
  
  tour     Tour      @relation(fields: [tourId], references: [id])
  bookings Booking[]

  // Optimistic Locking: Dùng version để chặn race condition khi đặt chỗ
  version  Int       @default(1)

  @@map("tour_schedules")
}

enum ScheduleStatus {
  OPEN
  SOLD_OUT
  CLOSED
  COMPLETED
}

// --- 4. BOOKINGS (Sales) ---
model Booking {
  id          Int           @id @default(autoincrement())
  userId      Int           @map("user_id")
  scheduleId  Int           @map("schedule_id")
  bookingDate DateTime      @default(now()) @map("booking_date")
  totalPrice  Decimal       @map("total_price") @db.Decimal(12, 2)
  status      BookingStatus @default(PENDING)
  note        String?

  user      User            @relation(fields: [userId], references: [id])
  schedule  TourSchedule    @relation(fields: [scheduleId], references: [id])
  travelers BookingTraveler[]
  payments  Payment[]
  refunds   Refund[]

  @@map("bookings")
}

enum BookingStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

// Chi tiết người đi
model BookingTraveler {
  id        Int      @id @default(autoincrement())
  bookingId Int      @map("booking_id")
  fullName  String   @map("full_name")
  gender    String?
  ageGroup  AgeGroup @map("age_group")
  price     Decimal  @db.Decimal(10, 2) // Giá snapshot tại thời điểm đặt

  booking Booking @relation(fields: [bookingId], references: [id])

  @@map("booking_travelers")
}

enum AgeGroup {
  ADULT
  CHILD
  BABY
}

// --- 5. PAYMENT & REFUND ---
model Payment {
  id            Int           @id @default(autoincrement())
  bookingId     Int           @map("booking_id")
  userId        Int           @map("user_id")
  amount        Decimal       @db.Decimal(12, 2)
  provider      String        // 'stripe', 'paypal'
  transactionId String        @map("transaction_id")
  status        PaymentStatus
  createdAt     DateTime      @default(now()) @map("created_at")

  booking Booking @relation(fields: [bookingId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
  refunds Refund[]

  @@map("payments")
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

model Refund {
  id             Int          @id @default(autoincrement())
  bookingId      Int          @map("booking_id")
  paymentId      Int          @map("payment_id")
  amount         Decimal      @db.Decimal(12, 2)
  reason         String?
  status         RefundStatus @default(PENDING)
  gatewayRefundId String?     @map("gateway_refund_id")
  createdAt      DateTime     @default(now()) @map("created_at")

  booking Booking @relation(fields: [bookingId], references: [id])
  payment Payment @relation(fields: [paymentId], references: [id])

  @@map("refunds")
}

enum RefundStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// --- 6. REVIEWS ---
model Review {
  id        Int      @id @default(autoincrement())
  tourId    Int      @map("tour_id")
  userId    Int      @map("user_id")
  rating    Int
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  tour Tour @relation(fields: [tourId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@map("reviews")
}